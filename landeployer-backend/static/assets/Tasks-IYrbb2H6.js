import{g as G,b as R}from"./deploy-B6WCszwX.js";import{_ as H,r as y,o as J,c as U,a as o,b as l,w as t,d as r,E as x,g as K,e as k,h as P,f as s,i as u,F as Q,l as W,t as f,j as V}from"./index-B5noXiXf.js";import"./request-Czxk6xGR.js";const X={class:"tasks-page"},Y={class:"toolbar"},Z={style:{"margin-top":"20px"}},h={__name:"Tasks",setup(ee){const b=y(!1),C=y([]),c=y(!1),a=y(null);let m=null;const v=async()=>{b.value=!0;try{const i=await G();C.value=i.data||[]}catch{x.error("加载任务列表失败")}finally{b.value=!1}},D=async i=>{try{const e=await R(i.id);a.value=e.data,c.value=!0,a.value.status==="running"&&M()}catch{x.error("加载任务详情失败")}},N=async()=>{if(a.value)try{const i=await R(a.value.id);a.value=i.data,a.value.status!=="running"&&(I(),v())}catch{x.error("刷新任务失败")}},M=()=>{m&&clearInterval(m),m=setInterval(()=>{N()},3e3)},I=()=>{m&&(clearInterval(m),m=null)};J(()=>{v();const i=setInterval(()=>{v()},1e4);E(()=>{clearInterval(i),I()})});const E=i=>{const{onUnmounted:e}=require("vue");e(i)};return(i,e)=>{const B=r("Refresh"),w=r("el-icon"),g=r("el-button"),_=r("el-table-column"),d=r("el-tag"),L=r("Loading"),z=r("el-progress"),A=r("el-table"),F=r("el-card"),p=r("el-descriptions-item"),$=r("el-alert"),j=r("el-descriptions"),q=r("el-input"),O=r("el-dialog"),S=K("loading");return o(),U("div",X,[l(F,null,{default:t(()=>[k("div",Y,[e[4]||(e[4]=k("h3",null,"任务历史",-1)),l(g,{onClick:v},{default:t(()=>[l(w,null,{default:t(()=>[l(B)]),_:1}),e[3]||(e[3]=s(" 刷新 ",-1))]),_:1})]),P((o(),u(A,{data:C.value,style:{"margin-top":"20px"}},{default:t(()=>[l(_,{prop:"taskName",label:"任务名称",width:"250","show-overflow-tooltip":""}),l(_,{prop:"hostName",label:"服务器",width:"150"}),l(_,{label:"角色",width:"250"},{default:t(({row:n})=>[(o(!0),U(Q,null,W(n.roles.split(","),T=>(o(),u(d,{key:T,size:"small",style:{"margin-right":"5px"}},{default:t(()=>[s(f(T),1)]),_:2},1024))),128))]),_:1}),l(_,{label:"状态",width:"120"},{default:t(({row:n})=>[n.status==="pending"?(o(),u(d,{key:0,type:"info"},{default:t(()=>[...e[5]||(e[5]=[s("等待中",-1)])]),_:1})):n.status==="running"?(o(),u(d,{key:1,type:"warning"},{default:t(()=>[l(w,{class:"is-loading"},{default:t(()=>[l(L)]),_:1}),e[6]||(e[6]=s(" 执行中 ",-1))]),_:1})):n.status==="success"?(o(),u(d,{key:2,type:"success"},{default:t(()=>[...e[7]||(e[7]=[s("成功",-1)])]),_:1})):n.status==="failed"?(o(),u(d,{key:3,type:"danger"},{default:t(()=>[...e[8]||(e[8]=[s("失败",-1)])]),_:1})):(o(),u(d,{key:4,type:"info"},{default:t(()=>[...e[9]||(e[9]=[s("已取消",-1)])]),_:1}))]),_:1}),l(_,{label:"进度",width:"150"},{default:t(({row:n})=>[l(z,{percentage:n.progress,status:n.status==="failed"?"exception":n.status==="success"?"success":""},null,8,["percentage","status"])]),_:1}),l(_,{prop:"createTime",label:"创建时间",width:"180"}),l(_,{label:"操作",width:"120",fixed:"right"},{default:t(({row:n})=>[l(g,{size:"small",onClick:T=>D(n)},{default:t(()=>[...e[10]||(e[10]=[s("查看详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[S,b.value]])]),_:1}),l(O,{modelValue:c.value,"onUpdate:modelValue":e[2]||(e[2]=n=>c.value=n),title:"任务详情",width:"800px"},{footer:t(()=>[l(g,{onClick:e[1]||(e[1]=n=>c.value=!1)},{default:t(()=>[...e[15]||(e[15]=[s("关闭",-1)])]),_:1}),a.value&&a.value.status==="running"?(o(),u(g,{key:0,type:"primary",onClick:N},{default:t(()=>[l(w,null,{default:t(()=>[l(B)]),_:1}),e[16]||(e[16]=s(" 刷新 ",-1))]),_:1})):V("",!0)]),default:t(()=>[a.value?(o(),u(j,{key:0,column:2,border:""},{default:t(()=>[l(p,{label:"任务名称",span:2},{default:t(()=>[s(f(a.value.taskName),1)]),_:1}),l(p,{label:"服务器"},{default:t(()=>[s(f(a.value.hostName),1)]),_:1}),l(p,{label:"状态"},{default:t(()=>[a.value.status==="success"?(o(),u(d,{key:0,type:"success"},{default:t(()=>[...e[11]||(e[11]=[s("成功",-1)])]),_:1})):a.value.status==="failed"?(o(),u(d,{key:1,type:"danger"},{default:t(()=>[...e[12]||(e[12]=[s("失败",-1)])]),_:1})):a.value.status==="running"?(o(),u(d,{key:2,type:"warning"},{default:t(()=>[...e[13]||(e[13]=[s("执行中",-1)])]),_:1})):(o(),u(d,{key:3,type:"info"},{default:t(()=>[s(f(a.value.status),1)]),_:1}))]),_:1}),l(p,{label:"进度"},{default:t(()=>[s(f(a.value.progress)+"% ",1)]),_:1}),l(p,{label:"创建人"},{default:t(()=>[s(f(a.value.createBy),1)]),_:1}),l(p,{label:"创建时间"},{default:t(()=>[s(f(a.value.createTime),1)]),_:1}),l(p,{label:"开始时间"},{default:t(()=>[s(f(a.value.startTime||"-"),1)]),_:1}),l(p,{label:"结束时间"},{default:t(()=>[s(f(a.value.endTime||"-"),1)]),_:1}),a.value.errorMsg?(o(),u(p,{key:0,label:"错误信息",span:2},{default:t(()=>[l($,{title:a.value.errorMsg,type:"error",closable:!1},null,8,["title"])]),_:1})):V("",!0)]),_:1})):V("",!0),k("div",Z,[e[14]||(e[14]=k("h4",null,"执行日志",-1)),l(q,{modelValue:a.value.logs,"onUpdate:modelValue":e[0]||(e[0]=n=>a.value.logs=n),type:"textarea",rows:15,readonly:"",style:{"margin-top":"10px","font-family":"monospace"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}},se=H(h,[["__scopeId","data-v-8d6b600c"]]);export{se as default};
