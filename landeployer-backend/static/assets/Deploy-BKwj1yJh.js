import{_ as Z,r as c,o as ee,c as y,a as s,b as t,w as l,d as n,E as b,u as te,g as le,j as x,e as r,h as oe,i as u,f as i,F as E,l as F,n as ae,t as m}from"./index-B5noXiXf.js";import{g as se}from"./host-aZwPL29u.js";import{a as ne}from"./role-BcOSM6QJ.js";import{c as re,a as ie}from"./deploy-B6WCszwX.js";import"./request-Czxk6xGR.js";const de={class:"deploy-page"},ue={key:0},pe={class:"step-footer"},ce={key:1},_e={class:"roles-grid"},me={class:"role-icon"},ve={class:"role-name"},fe={class:"role-desc"},ye={class:"role-ports"},ge={class:"step-footer"},ke={key:2},be={class:"step-footer"},we={key:3},he={class:"step-footer"},xe={__name:"Deploy",setup(Ce){const I=te(),w=c(!1),N=c(!1),p=c(0),H=c([]),D=c([]),v=c(null),_=c([]),C=c([]),g=c({taskName:""}),U=async()=>{w.value=!0;try{const a=await se();H.value=a.data||[]}catch{b.error("加载服务器列表失败")}finally{w.value=!1}},T=async()=>{try{const a=await ne();D.value=a.data||[]}catch{b.error("加载角色列表失败")}},j=a=>{v.value=a.length>0?a[0]:null},z=a=>{const e=_.value.indexOf(a);e>-1?_.value.splice(e,1):_.value.push(a)},L=async()=>{w.value=!0;try{const a=await re({hostId:v.value.id,roleCodes:_.value});C.value=a.data||[],P()}catch{b.error("检查资源包失败")}finally{w.value=!1}},O=async()=>{if(!g.value.taskName){b.warning("请输入任务名称");return}N.value=!0;try{const a=await ie({taskName:g.value.taskName,hostId:v.value.id,roleCodes:_.value,createBy:"admin"});b.success("部署任务已创建"),I.push("/tasks")}catch{b.error("创建部署任务失败")}finally{N.value=!1}},P=()=>{p.value<3&&p.value++},V=()=>{p.value>0&&p.value--};return ee(()=>{U(),T();const a=new Date;g.value.taskName=`部署任务_${a.getFullYear()}${(a.getMonth()+1).toString().padStart(2,"0")}${a.getDate().toString().padStart(2,"0")}_${a.getHours().toString().padStart(2,"0")}${a.getMinutes().toString().padStart(2,"0")}`}),(a,e)=>{const S=n("el-step"),Y=n("el-steps"),d=n("el-table-column"),h=n("el-tag"),M=n("el-table"),f=n("el-button"),R=n("el-card"),$=n("el-alert"),B=n("el-descriptions-item"),q=n("el-descriptions"),A=n("el-input"),G=n("el-form-item"),J=n("el-form"),K=n("Upload"),Q=n("el-icon"),W=le("loading");return s(),y("div",de,[t(R,null,{default:l(()=>[t(Y,{active:p.value,"align-center":"",style:{"margin-bottom":"30px"}},{default:l(()=>[t(S,{title:"选择服务器"}),t(S,{title:"选择角色"}),t(S,{title:"检查资源"}),t(S,{title:"开始部署"})]),_:1},8,["active"]),p.value===0?(s(),y("div",ue,[e[4]||(e[4]=r("h3",null,"选择目标服务器",-1)),oe((s(),u(M,{data:H.value,onSelectionChange:j,style:{"margin-top":"20px"}},{default:l(()=>[t(d,{type:"selection",width:"55",selectable:o=>o.status==="online"},null,8,["selectable"]),t(d,{prop:"name",label:"名称",width:"150"}),t(d,{prop:"ip",label:"IP地址",width:"150"}),t(d,{prop:"remotePath",label:"部署路径",width:"200"}),t(d,{label:"状态",width:"100"},{default:l(({row:o})=>[o.status==="online"?(s(),u(h,{key:0,type:"success"},{default:l(()=>[...e[1]||(e[1]=[i("在线",-1)])]),_:1})):(s(),u(h,{key:1,type:"danger"},{default:l(()=>[...e[2]||(e[2]=[i("离线",-1)])]),_:1}))]),_:1}),t(d,{prop:"description",label:"描述","show-overflow-tooltip":""})]),_:1},8,["data"])),[[W,w.value]]),r("div",pe,[t(f,{type:"primary",disabled:v.value===null,onClick:P},{default:l(()=>[...e[3]||(e[3]=[i(" 下一步 ",-1)])]),_:1},8,["disabled"])])])):x("",!0),p.value===1?(s(),y("div",ce,[e[7]||(e[7]=r("h3",null,"选择部署角色",-1)),r("div",_e,[(s(!0),y(E,null,F(D.value,o=>(s(),u(R,{key:o.code,class:ae(["role-card",{selected:_.value.includes(o.code)}]),onClick:k=>z(o.code),shadow:"hover"},{default:l(()=>[r("div",me,m(o.icon),1),r("div",ve,m(o.name),1),r("div",fe,m(o.description),1),r("div",ye,"端口: "+m(o.ports),1)]),_:2},1032,["class","onClick"]))),128))]),r("div",ge,[t(f,{onClick:V},{default:l(()=>[...e[5]||(e[5]=[i("上一步",-1)])]),_:1}),t(f,{type:"primary",disabled:_.value.length===0,onClick:L},{default:l(()=>[...e[6]||(e[6]=[i(" 下一步 ",-1)])]),_:1},8,["disabled"])])])):x("",!0),p.value===2?(s(),y("div",ke,[e[13]||(e[13]=r("h3",null,"检查服务器资源",-1)),C.value.length===0?(s(),u($,{key:0,title:"✓ 所有资源包已就绪",type:"success",closable:!1,style:{margin:"20px 0"}})):(s(),u($,{key:1,title:"⚠ 发现缺失的资源包",type:"warning",closable:!1,style:{margin:"20px 0"}})),C.value.length>0?(s(),u(M,{key:2,data:C.value,style:{"margin-top":"20px"}},{default:l(()=>[t(d,{prop:"roleName",label:"角色",width:"150"}),t(d,{prop:"packageName",label:"包名称",width:"250"}),t(d,{prop:"remotePath",label:"远程路径","show-overflow-tooltip":""}),t(d,{label:"状态",width:"100"},{default:l(({row:o})=>[o.exists?(s(),u(h,{key:0,type:"success"},{default:l(()=>[...e[8]||(e[8]=[i("已存在",-1)])]),_:1})):(s(),u(h,{key:1,type:"danger"},{default:l(()=>[...e[9]||(e[9]=[i("缺失",-1)])]),_:1}))]),_:1})]),_:1},8,["data"])):x("",!0),t($,{type:"info",closable:!1,style:{"margin-top":"20px"}},{default:l(()=>[...e[10]||(e[10]=[r("p",null,"如发现缺失的包，请手动将对应文件上传到服务器的指定目录，或联系管理员。",-1)])]),_:1}),r("div",be,[t(f,{onClick:V},{default:l(()=>[...e[11]||(e[11]=[i("上一步",-1)])]),_:1}),t(f,{type:"primary",onClick:P},{default:l(()=>[...e[12]||(e[12]=[i(" 下一步 ",-1)])]),_:1})])])):x("",!0),p.value===3?(s(),y("div",we,[e[16]||(e[16]=r("h3",null,"确认部署信息",-1)),t(q,{column:2,border:"",style:{"margin-top":"20px"}},{default:l(()=>[t(B,{label:"目标服务器"},{default:l(()=>{var o,k;return[i(m((o=v.value)==null?void 0:o.name)+" ("+m((k=v.value)==null?void 0:k.ip)+") ",1)]}),_:1}),t(B,{label:"部署路径"},{default:l(()=>{var o;return[i(m((o=v.value)==null?void 0:o.remotePath),1)]}),_:1}),t(B,{label:"部署角色",span:2},{default:l(()=>[(s(!0),y(E,null,F(_.value,o=>(s(),u(h,{key:o,style:{"margin-right":"5px"}},{default:l(()=>{var k;return[i(m((k=D.value.find(X=>X.code===o))==null?void 0:k.name),1)]}),_:2},1024))),128))]),_:1})]),_:1}),t(J,{model:g.value,style:{"margin-top":"30px","max-width":"500px"}},{default:l(()=>[t(G,{label:"任务名称"},{default:l(()=>[t(A,{modelValue:g.value.taskName,"onUpdate:modelValue":e[0]||(e[0]=o=>g.value.taskName=o),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),r("div",he,[t(f,{onClick:V},{default:l(()=>[...e[14]||(e[14]=[i("上一步",-1)])]),_:1}),t(f,{type:"success",onClick:O,loading:N.value},{default:l(()=>[t(Q,null,{default:l(()=>[t(K)]),_:1}),e[15]||(e[15]=i(" 开始部署 ",-1))]),_:1},8,["loading"])])])):x("",!0)]),_:1})])}}},$e=Z(xe,[["__scopeId","data-v-e1f76193"]]);export{$e as default};
